<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UrbanGreentech — View Reports</title>
  <style>
    body{
        font-family:Inter,Segoe UI,Arial;
        margin:0;
        background:var(--bg);
        color:inherit;
        padding:16px;
    }
    .wrap{
        max-width:1100px;
        margin:18px auto;
        padding:16px;
        background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);
        border-radius:12px;
    }
    header{
        display:flex;
        align-items:center;
        justify-content:space-between;
    }
    .controls{
        display:flex;
        gap:8px;
    }
    .btn{
        padding:8px 12px;
        border-radius:8px;
        border:1px solid rgba(11,19,32,0.08);
        background:var(--card);
        cursor:pointer;
    }
    .search{
        display:flex;
        gap:8px;
        margin:12px 0;
    }
    input[type="search"]{
        flex:1;
        padding:8px;
        border-radius:8px;
        border:1px solid rgba(11,19,32,0.08);
    }
    .cards{
        display:grid;
        grid-template-columns:repeat(3,1fr);
        gap:12px;
    }
    .card{
        background:var(--card);
        padding:12px;
        border-radius:10px;
        box-shadow:0 4px 14px rgba(12,18,22,0.04);
    }
    .meta{
        font-size:12px;
        color:var(--muted);
    }
    .no-data{
        text-align:center;
        padding:40px;
        color:var(--muted);
    }
    @media(max-width:900px){
        .cards{
            grid-template-columns:repeat(2,1fr);
        }
    }
    @media(max-width:600px){
        .cards
        {
            grid-template-columns:1fr;
        }
    }    
  </style>
</head>
<body>
  <div class="wrap" id="viewer">
    <header>
      <h2>Submitted Plant Reports</h2>
      <div class="controls">
        <a class="btn" href="Urban-submit.html">Back to Form</a>
        <button id="exportBtn" class="btn">Export JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="btn">Import JSON</button>
      </div>
    </header>

    <div class="small meta">Last viewed: <span id="lastViewed">—</span></div>

    <div class="search">
      <input id="q" type="search" placeholder="Search by plant name or location" />
      <select id="locFilter"><option value="">All locations</option><option>Balcony</option><option>Bedroom</option><option>Kitchen</option><option>Living Room</option><option>Office</option></select>
      <button id="clearSearch" class="btn">Clear</button>
    </div>

    <div id="results" class="cards" aria-live="polite"></div>
    <div id="nodata" class="no-data" style="display:none">No data found</div>
  </div>

  <script type="module">
    class ReportViewer{
      constructor(root){
        this.root = root; this.storageKey = 'plantReports';
        this.results = root.querySelector('#results');
        this.noData = root.querySelector('#nodata');
        this.query = root.querySelector('#q'); this.locFilter = root.querySelector('#locFilter');
        this.lastViewedEl = root.querySelector('#lastViewed');
        this._bind();
        this._render();
        this._setLastViewed();
      }

      _bind(){
        this.query.addEventListener('input', ()=> this._render());
        this.locFilter.addEventListener('change', ()=> this._render());
        this.root.querySelector('#clearSearch').addEventListener('click', ()=>{ this.query.value=''; this.locFilter.value=''; this._render();});
        this.root.querySelector('#exportBtn').addEventListener('click', ()=> this._export());
        this.root.querySelector('#importBtn').addEventListener('click', ()=> this.root.querySelector('#importFile').click());
        this.root.querySelector('#importFile').addEventListener('change', (e)=> this._import(e));
        // event delegation for delete
        this.results.addEventListener('click', (e)=>{
          const del = e.target.closest('[data-action="delete"]');
          if(del){ const id = del.dataset.id; this._delete(id); }
        });
      }

      _getAll(){
        return JSON.parse(localStorage.getItem(this.storageKey) || '[]');
      }

      _render(){
        const q = this.query.value.trim().toLowerCase();
        const loc = this.locFilter.value;
        const all = this._getAll();
        const filtered = all.filter(r=>{
          const matchQ = !q || r.plantName.toLowerCase().includes(q) || r.location.toLowerCase().includes(q);
          const matchLoc = !loc || r.location === loc;
          return matchQ && matchLoc;
        });

        this.results.innerHTML = '';
        if(!filtered.length){ this.noData.style.display='block'; return; } else this.noData.style.display='none';

        filtered.slice().reverse().forEach(r=>{ // newest first
          const card = document.createElement('article'); card.className='card';
          card.innerHTML = `<h3>${escapeHtml(r.plantName)}</h3>
            <div class="meta">Location: ${escapeHtml(r.location)} • Water every ${r.frequency} day(s)</div>
            <div class="meta">Last watered: ${new Date(r.lastWatered).toLocaleDateString()}</div>
            <p style="margin:8px 0">${escapeHtml(r.notes)}</p>
            <div style="display:flex;gap:8px;justify-content:flex-end"><button data-action="delete" data-id="${r.id}" class="btn">Delete</button></div>`;
          this.results.appendChild(card);
        });
      }

      _delete(id){
        const all = this._getAll();
        const next = all.filter(r=> r.id !== id);
        localStorage.setItem(this.storageKey, JSON.stringify(next));
        this._render();
      }

      _export(){
        const data = this._getAll();
        const blob = new Blob([JSON.stringify(data, null, 2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'plantReports.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      _import(e){
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (ev)=>{
          try{
            const parsed = JSON.parse(ev.target.result);
            if(!Array.isArray(parsed)) throw new Error('JSON must be an array');
            // simple merge: append
            const existing = this._getAll();
            const merged = existing.concat(parsed.map(item=> ({...item, id: item.id || (Date.now()+Math.random()).toString(36)})));
            localStorage.setItem(this.storageKey, JSON.stringify(merged));
            this._render();
            alert('Import successful');
          }catch(err){ alert('Import failed: '+err.message); }
        };
        reader.readAsText(f);
        // clear input
        e.target.value = '';
      }

      _setLastViewed(){
        const now = new Date().toLocaleString();
        sessionStorage.setItem('ug_last_viewed', now);
        this.lastViewedEl.textContent = now;
      }
    }

    function escapeHtml(s){ return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;'); }

    document.addEventListener('DOMContentLoaded', ()=>{
      new ReportViewer(document.getElementById('viewer'));
    });
  </script>
</body>
</html>
